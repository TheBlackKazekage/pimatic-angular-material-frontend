/*! 
 * Name:        pimatic-angular-material-frontend 
 * Description: Provides an AngularJS webinterface for Pimatic with material design. 
 * Version:     0.1.2 
 * Homepage:    http://github.com/denniss17/pimatic-angular-material-frontend 
 * Date:        2015-10-16 
 */
angular.module("pimaticApp.configuration",[]),angular.module("pimaticApp.configuration").constant("pimaticHost",""),angular.module("pimaticApp.configuration").constant("apiName","websocketApi"),angular.module("pimaticApp.devices",[]),angular.module("pimaticApp.settings",[]),angular.module("pimaticApp.api",["pimaticApp.configuration"]),angular.module("pimaticApp.services",["pimaticApp.api","pimaticApp.configuration"]),angular.module("pimaticApp",["ngMaterial","ngRoute","ngMessages","pimaticApp.configuration","pimaticApp.devices","pimaticApp.services","pimaticApp.settings","pascalprecht.translate","mdThemeColors"]),angular.module("pimaticApp").config(["$routeProvider","$logProvider","$injector","debug",function(a,b,c,d){a.when("/home",{templateUrl:"partials/home.html",controller:"HomeController"}).when("/landing",{}).when("/about",{templateUrl:"partials/about.html"}).when("/login",{templateUrl:"partials/login.html",controller:"LoginController"}).when("/home/:pageId",{templateUrl:"partials/home.html",controller:"HomeController"}).when("/settings/groups",{templateUrl:"partials/settings/groups/index.html",controller:"GroupsController"}).when("/settings/groups/create",{templateUrl:"partials/settings/groups/create.html",controller:"GroupsCreateController"}).when("/settings/groups/:id",{templateUrl:"partials/settings/groups/edit.html",controller:"GroupsEditController"}).when("/settings/devices",{templateUrl:"partials/settings/devices/index.html",controller:"DevicesController"}).otherwise({redirectTo:"/landing"}),d="false"!=d,b.debugEnabled(d)}]),angular.module("pimaticApp.services").config(["storeProvider","apiName",function(a,b){a.setApi(b)}]),angular.module("pimaticApp").run(["$rootScope","$location","$injector","$log","store","auth","version",function(a,b,c,d,e,f,g){a.store=e,a.auth=f,a.version="@@version"==g?"development":g,a.state="starting",a.redirectedFrom=null,a.setState=function(c){a.state=c,("done"==c||"unauthenticated"==c)&&(angular.isUndefined(a.redirectedFrom)||null===a.redirectedFrom?(d.debug("New state:",c,"Redirecting to ","unauthenticated"==c?"/login":"/home"),b.path("unauthenticated"==c?"/login":"/home")):(b.path(a.redirectedFrom),d.debug("New state:",c,"Redirecting to ",a.redirectedFrom),a.redirectedFrom=null))},e.reload(),a.$on("$routeChangeStart",function(c,e){"starting"==a.state?"/landing"!=e.originalPath&&(d.debug("App","Application is loading, redirecting to the landing page"),a.redirectedFrom=e.originalPath,b.path("/landing")):f.isLoggedIn()||"/login"==e.originalPath||(d.debug("pimaticApp","Redirecting to login..."),a.redirectedFrom=e.originalPath,b.path("/login"))})}]),angular.module("pimaticApp").config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("blue").accentPalette("orange")}]),angular.module("pimaticApp.api").factory("baseApi",["$q",function(a){return{store:null,toQueryString:function(a,b){var c=this,d=[];return angular.forEach(a,function(a,e){var f=angular.isUndefined(b)?encodeURIComponent(e):b+"["+encodeURIComponent(e)+"]";d.push(angular.isObject(a)?c.toQueryString(a,f):f+"="+encodeURIComponent(a))}),d.join("&")},setStore:function(a){this.store=a},deviceAction:function(){return a(function(a,b){b()})},login:function(){return a(function(a,b){b("Not implemented")})},logout:function(){return a(function(a,b){b("Not implemented")})},start:function(){},load:function(){return a(function(a,b){b("Not implemented")})},add:function(){return a(function(a,b){b("Not implemented")})},update:function(){return a(function(a,b){b("Not implemented")})},remove:function(){return a(function(a,b){b("Not implemented")})}}}]),angular.module("pimaticApp.api").factory("fixtureApi",["$http","$q","baseApi",function(a,b,c){var d={};return angular.extend({},c,{start:function(){d={},a.get("assets/fixtures/devices.json").then(function(a){d.devices=a.data},function(){d.devices=[]}),a.get("assets/fixtures/groups.json").then(function(a){d.groups=a.data},function(){d.groups=[]}),a.get("assets/fixtures/pages.json").then(function(a){d.pages=a.data},function(){d.pages=[]}),a.get("assets/fixtures/rules.json").then(function(a){d.rules=a.data},function(){d.rules=[]}),a.get("assets/fixtures/variables.json").then(function(a){d.variables=a.data},function(){d.variables=[]})},load:function(a){return b(function(b){for(;!(a in d););b(d[a])})}})}]),angular.module("pimaticApp.api").factory("websocketApi",["$http","$q","$rootScope","$log","baseApi","pimaticHost","toast",function(a,b,c,d,e,f,g){var h={},i={groups:"group"};return angular.extend({},e,{socket:null,start:function(){h={},this.setupSocket()},apply:function(a){c.$$phase?a():c.$apply(a)},setupSocket:function(){var a=this.store,b=this;null!==this.socket&&this.socket.disconnect(),this.socket=io(f,{reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:3e3,timeout:2e4,forceNew:!0}),this.socket.on("connect",function(){d.debug("websocketApi","connect"),b.socket.emit("call",{id:"errorMessageCount",action:"queryMessagesCount",params:{criteria:{level:"error"}}}),b.socket.emit("call",{id:"guiSettings",action:"getGuiSettings",params:{}}),b.socket.emit("call",{id:"updateProcessStatus",action:"getUpdateProcessStatus",params:{}})}),this.socket.on("error",function(a){d.debug("websocketApi","error",a),b.apply(function(){c.setState("unauthenticated")})}),this.socket.on("disconnect",function(){d.debug("websocketApi","disconnect")}),this.socket.on("hello",function(a){d.debug("websocketApi","hello",a),b.apply(function(){b.store.setUser(a),c.setState("done")})}),this.socket.on("callResult",function(a){switch(d.debug("websocketApi","callResult",a),a.id){case"errorMessageCount":break;case"guiSettings":break;case"updateProcessStatus":}}),this.socket.on("devices",function(a){d.debug("websocketApi","devices",a),b.handleIncomingData("devices",a)}),this.socket.on("rules",function(a){d.debug("websocketApi","rules",a),b.handleIncomingData("rules",a)}),this.socket.on("variables",function(a){d.debug("websocketApi","variables",a),b.handleIncomingData("variables",a)}),this.socket.on("pages",function(a){d.debug("websocketApi","pages",a),b.handleIncomingData("pages",a)}),this.socket.on("groups",function(a){d.debug("websocketApi","groups",a),b.handleIncomingData("groups",a)}),this.socket.on("deviceAttributeChanged",function(c){d.debug("websocketApi","deviceAttributeChanged",c),b.apply(function(){var b=a.get("devices",c.deviceId);null!==b&&angular.forEach(b.attributes,function(a){a.name==c.attributeName&&(a.value=c.value,a.lastUpdate=c.time)})})}),this.socket.on("variableValueChanged",function(c){d.debug("websocketApi","variableValueChanged",c),b.apply(function(){var b=a.get("variables",c.variableName);null!==b&&(b.value=c.variableValue)})}),this.socket.on("deviceChanged",function(c){d.debug("websocketApi","deviceChanged",c),b.apply(function(){a.update("devices",c,!0)})}),this.socket.on("deviceRemoved",function(c){d.debug("websocketApi","deviceRemoved",c),b.apply(function(){a.remove("devices",c,!0)})}),this.socket.on("deviceAdded",function(c){d.debug("websocketApi","deviceAdded",c),b.apply(function(){a.add("devices",c,!0)})}),this.socket.on("deviceOrderChanged",function(a){d.debug("websocketApi","deviceOrderChanged",a)}),this.socket.on("pageChanged",function(c){d.debug("websocketApi","pageChanged",c),b.apply(function(){a.update("pages",c,!0)})}),this.socket.on("pageRemoved",function(c){d.debug("websocketApi","pageRemoved",c),b.apply(function(){a.remove("pages",c,!0)})}),this.socket.on("pageAdded",function(c){d.debug("websocketApi","pageAdded",c),b.apply(function(){a.add("pages",c,!0)})}),this.socket.on("pageOrderChanged",function(a){d.debug("websocketApi","pageOrderChanged",a)}),this.socket.on("groupChanged",function(c){d.debug("websocketApi","groupChanged",c),b.apply(function(){a.update("groups",c,!0)})}),this.socket.on("groupRemoved",function(c){d.debug("websocketApi","groupRemoved",c),b.apply(function(){a.remove("groups",c,!0)})}),this.socket.on("groupAdded",function(c){d.debug("websocketApi","groupAdded",c),b.apply(function(){a.add("groups",c,!0)})}),this.socket.on("groupOrderChanged",function(a){d.debug("websocketApi","groupOrderChanged",a)}),this.socket.on("ruleChanged",function(c){d.debug("websocketApi","ruleChanged",c),b.apply(function(){a.update("rules",c,!0)})}),this.socket.on("ruleAdded",function(c){d.debug("websocketApi","ruleAdded",c),b.apply(function(){a.add("rules",c,!0)})}),this.socket.on("ruleRemoved",function(c){d.debug("websocketApi","ruleRemoved",c),b.apply(function(){a.remove("rules",c,!0)})}),this.socket.on("ruleOrderChanged",function(a){d.debug("websocketApi","ruleOrderChanged",a)}),this.socket.on("variableChanged",function(c){d.debug("websocketApi","variableChanged",c),b.apply(function(){a.update("variables",c,!0)})}),this.socket.on("variableAdded",function(c){d.debug("websocketApi","variableAdded",c),b.apply(function(){a.add("variables",c,!0)})}),this.socket.on("variableRemoved",function(c){d.debug("websocketApi","variableRemoved",c),b.apply(function(){a.remove("variables",c,!0)})}),this.socket.on("variableOrderChanged",function(a){d.debug("websocketApi","variableOrderChanged",a)}),this.socket.on("updateProcessStatus",function(a){d.debug("websocketApi","updateProcessStatus",a)}),this.socket.on("updateProcessMessage",function(a){d.debug("websocketApi","updateProcessMessage",a)}),this.socket.on("messageLogged",function(a){d.debug("websocketApi","messageLogged",a),"debug"!=a.level&&g.show(a.msg),"error"==a.level})},login:function(c,d,e){return b(function(b,g){var h={username:c,password:d};e&&(h.rememberMe=!0),a.post(f+"/login",h).success(function(a){a.success?b({username:a.username,rememberMe:a.rememberMe,role:a.role}):g(a.message)}).error(function(a){g(a.message)})})},logout:function(){return b(function(b){a.get(f+"/logout").success(function(){b()}).error(function(){b()})})},handleIncomingData:function(a,b){a in h&&"promises"in h[a]?(angular.forEach(h[a].promises,function(a){a.resolve(b)}),delete h[a]):(h[a]={},h[a].data=b)},deviceAction:function(c,d,e){var g=this;return b(function(b,h){var i=f+"/api/device/"+c+"/"+d;!angular.isUndefined(e)&&angular.isObject(e)&&(i+="?"+g.toQueryString(e)),a.get(i).success(function(a){a.success?b():h()}).error(function(){h()})})},add:function(c,d){return b(function(b,e){var g=i[c],h={};h[g]=d,a.post(f+"/api/"+c+"/"+d.id,h).then(function(a){b(a[g])},function(a){e(a.message)})})},update:function(c,d){return b(function(b,e){var g=i[c],h={};h[g]=d,a.patch(f+"/api/"+c+"/"+d.id,h).then(function(a){b(a[g])},function(a){e(a.message)})})},remove:function(c,d){return b(function(b,e){a["delete"](f+"/api/"+c+"/"+d.id).then(function(a){b(a.removed)},function(a){e(a.message)})})},load:function(a){if(a in h&&"data"in h[a]){var c=b(function(b){b(h[a].data)});return delete h[a],c}var d=b.defer();return angular.isUndefined(h[a])&&(h[a]={}),angular.isUndefined(h[a].promises)&&(h[a].promises=[]),h[a].promises.push(d),d.promise}})}]),angular.module("pimaticApp.services").factory("auth",["store","$injector","$location","$q",function(a,b,c,d){var e={store:a,isLoggedIn:function(){return null!==a.getUser()},login:function(b,c,e){var f=this;return d(function(d,g){f.store.api.login(b,c,e).then(function(b){a.reload(),a.setUser(b),d(b)},g)})},logout:function(){var b=this;return d(function(c,d){b.store.api.logout().then(function(){a.setUser(null),a.reset(),c()},d)})}};return e}]),angular.module("pimaticApp.services").factory("events",["toast",function(a){return{onDeviceActionDone:function(b,c){a.show("Done: "+c+" "+b.id)},onDeviceActionFail:function(b,c){a.error("Fail: "+c+" "+b.id)}}}]),angular.module("pimaticApp.services").provider("store",function(){var a=this;this.apiName="fixtureApi",this.$get=["$q","$log","$injector",function(b,c,d){return a.store.$q=b,a.store.$log=c,a.store.api=d.get(a.apiName),a.store}],this.setApi=function(a){this.apiName=a},this.store={api:null,store:{},reset:function(){this.$log.debug("=== STORE RESET ==="),this.store={user:{timestamp:0,loading:!1,data:null},devices:{timestamp:0,loading:!1,data:[]},groups:{timestamp:0,loading:!1,data:[]},pages:{timestamp:0,loading:!1,data:[]},rules:{timestamp:0,loading:!1,data:[]},variables:{timestamp:0,loading:!1,data:[]}},this.api.setStore(this)},reload:function(){this.reset(),this.api.start()},isLoading:function(a){return this.store[a].loading},getUser:function(){return this.store.user.data},setUser:function(a){this.store.user.data=a},get:function(a,b,c){var d=this;if(a in d.store){if(0!==d.store[a].timestamp||d.store[a].loading||(d.store[a].loading=!0,c||d.api.load(a).then(function(b){d.store[a].data=b;var c=new Date;d.store[a].timestamp=c.getTime(),d.store[a].loading=!1},function(){d.store[a].loading=!1})),angular.isUndefined(b))return d.store[a].data;var e=null;return angular.forEach(d.store[a].data,function(a){a.id==b&&(e=a)}),e}return angular.isUndefined(b)?[]:null},add:function(a,b,c){var d=this.api,e=this;this.$log.debug("store","add()","type=",a,"object=",b,"skipApi=",c);var f=function(){var d=e.get(a,b.id,c);return null===d?e.$q(function(d){e.get(a,void 0,c).push(b),d(b)}):e.update(a,b,c)};return e.$q(function(e,g){c?f(b).then(function(a){e(a)}):d.add(a,b).then(function(a){f(a).then(function(a){e(a)})},function(a){g(a)})})},update:function(a,b,c){var d=this.api,e=this;return this.$log.debug("store","update()","type=",a,"object=",b,"skipApi=",c),e.$q(function(f,g){var h=e.get(a,b.id);return null===h?void g("Fatal: update called, but object does not exist"):void(c?(angular.merge(h,b),f(h)):d.update(a,b).then(function(a){angular.merge(h,a),f(h)},function(a){g(a)}))})},remove:function(a,b,c){var d=this;if(this.$log.debug("store","remove()","type=",a,"object=",b,"skipApi=",c),!(a in d.store))return d.$q(function(a,b){b("Type is not valid")});var e=function(){var c=-1;angular.forEach(d.store[a].data,function(a,d){c=a.id==b.id?d:c}),c>=0&&d.store[a].data.splice(c,1)};return d.$q(function(f,g){c?(e(b),f(b)):d.api.remove(a,b).then(function(a){e(b),f(a)},function(a){g(a)})})}}}),angular.module("pimaticApp.services").factory("toast",["$mdToast",function(a){return{show:function(b){a.show(a.simple().content(b))},error:function(b){a.show(a.simple().content(b))}}}]),angular.module("pimaticApp.services").factory("utils",["store",function(a){return{getUngroupedDeviceIds:function(){var b=a.get("groups"),c=a.get("devices"),d=[];return angular.forEach(c,function(a){d.push(a.id)}),angular.forEach(b,function(a){angular.forEach(a.devices,function(a){var b=d.indexOf(a);b>=0&&d.splice(b,1)})}),d}}}]),angular.module("pimaticApp").filter("elapsed",function(){return function(a){var b=Math.floor(a/3600),c=b>9?b:"0"+b;a-=3600*b;var d=Math.floor(a/60);return c+=":"+(d>9?d:"0"+d),a-=60*d,c+=":"+(a>9?a:"0"+a)}}),angular.module("pimaticApp").filter("extract",function(){return function(a,b){return a.map(function(a){return a[b]})}}),angular.module("pimaticApp").filter("intersect",function(){return function(a,b){return a.filter(function(a){return-1!=b.indexOf(a)})}}),angular.module("pimaticApp.devices").controller("ButtonsController",["$scope","store","events",function(a,b,c){a.buttonPressed=function(d){var e="buttonPressed";b.api.deviceAction(a.device.id,e,{buttonId:d.id}).then(function(){c.onDeviceActionDone(a.device,e)},function(){c.onDeviceActionFail(a.device,e)})}}]),angular.module("pimaticApp.devices").controller("DimmerController",["$scope","store","events",function(a,b,c){a.updateDimlevel=function(d){var e="changeDimlevelTo";b.api.deviceAction(a.device.id,e,{dimlevel:d.value}).then(function(){c.onDeviceActionDone(a.device,e,{dimlevel:d.value})},function(){c.onDeviceActionFail(a.device,e,{dimlevel:d.value}),d.value=!d.value})}}]),angular.module("pimaticApp.devices").controller("ShutterController",["$scope","store","events",function(a,b,c){a.moveUp=function(){var d=a.getAttribute("position"),e="up"==d.value?"stop":"moveUp";b.api.deviceAction(a.device.id,e).then(function(){c.onDeviceActionDone(a.device,e)},function(){c.onDeviceActionFail(a.device,e)})},a.moveDown=function(){var d=a.getAttribute("position"),e="down"==d.value?"stop":"moveDown";b.api.deviceAction(a.device.id,e).then(function(){c.onDeviceActionDone(a.device,e)},function(){c.onDeviceActionFail(a.device,e)})}}]),angular.module("pimaticApp.devices").controller("SwitchController",["$scope","store","events",function(a,b,c){a.updateValue=function(d){var e=d.value?"turnOn":"turnOff";b.api.deviceAction(a.device.id,e).then(function(){c.onDeviceActionDone(a.device,e)},function(){d.value=!d.value,c.onDeviceActionFail(a.device,e)})}}]),angular.module("pimaticApp.devices").controller("ThermostatController",["$scope","store","events","mdThemeColors",function(a,b,c,d){a.themeColors=d,a.up=function(){a.setTemperatureSetpoint(a.getAttribute("temperatureSetpoint").value+.5)},a.down=function(){a.setTemperatureSetpoint(a.getAttribute("temperatureSetpoint").value-.5)},a.setTemperatureSetpoint=function(d){var e="changeTemperatureTo";b.api.deviceAction(a.device.id,e,{temperatureSetpoint:d}).then(function(){c.onDeviceActionDone(a.device,e)},function(){c.onDeviceActionFail(a.device,e)})},a.setMode=function(d){var e="changeModeTo";b.api.deviceAction(a.device.id,e,{mode:d}).then(function(){c.onDeviceActionDone(a.device,e)},function(){c.onDeviceActionFail(a.device,e)})},a.preset=function(b){var c=a.getConfig(b,!1);a.setTemperatureSetpoint(c)}}]),angular.module("pimaticApp.devices").controller("TimerController",["$scope","store","events",function(a,b,c){a.start=function(){var d="startTimer";b.api.deviceAction(a.device.id,d).then(function(){c.onDeviceActionDone(a.device,d)},function(){c.onDeviceActionFail(a.device,d)})},a.stop=function(){var d="stopTimer";b.api.deviceAction(a.device.id,d).then(function(){c.onDeviceActionDone(a.device,d)},function(){c.onDeviceActionFail(a.device,d)})},a.reset=function(){var d="resetTimer";b.api.deviceAction(a.device.id,d).then(function(){c.onDeviceActionDone(a.device,d)},function(){c.onDeviceActionFail(a.device,d)})}}]),angular.module("pimaticApp").controller("HomeController",["$scope","$filter","utils",function(a,b,c){a.selectedTab=0,a.getUngroupedDeviceIds=c.getUngroupedDeviceIds,a.getDeviceIds=function(c,d){return angular.isUndefined(d)?b("intersect")(b("extract")(c.devices,"deviceId"),a.getUngroupedDeviceIds()):b("intersect")(b("extract")(c.devices,"deviceId"),d.devices)}}]),angular.module("pimaticApp").controller("LoginController",["$scope","auth",function(a,b){null!==b.user&&a.setState("done"),a.form={},a.login=function(){a.form.message=null,a.form.busy=!0,b.login(a.form.username,a.form.password,a.form.rememberMe).then(function(){a.form.busy=!1,a.setState("done")},function(b){a.form.message=b,a.form.busy=!1})}}]),angular.module("pimaticApp").controller("MainController",["$scope","$mdSidenav","$mdMedia","auth",function(a,b,c,d){a.$mdMedia=c,a.toggleMenu=function(){b("left").toggle()},a.logout=function(){a.toggleMenu(),d.logout().then(function(){a.setState("unauthenticated")})}}]),angular.module("pimaticApp.settings").controller("DevicesController",["$scope","utils",function(a,b){a.getUngroupedDeviceIds=b.getUngroupedDeviceIds}]),angular.module("pimaticApp.settings").controller("GroupsCreateController",["$scope","$location","toast",function(a,b,c){a.group={},a.cancel=function(a){a.preventDefault(),b.path("settings/groups")},a.save=function(){a.store.add("groups",a.group).then(function(){b.path("settings/groups")},function(a){c.error("Saving group failed: "+a)})}}]),angular.module("pimaticApp.settings").controller("GroupsEditController",["$scope","$location","$routeParams","$mdDialog","toast",function(a,b,c,d,e){a.group=angular.copy(a.store.get("groups",c.id)),null===a.group&&b.path("settings/groups"),a.cancel=function(a){a.preventDefault(),b.path("settings/groups")},a["delete"]=function(c){c.preventDefault();var f=d.confirm().title("Are you sure you want to delete this group?").content(a.group.id).ariaLabel("Delete group").ok("Yes").cancel("No").targetEvent(c);d.show(f).then(function(){a.store.remove("groups",a.group).then(function(){b.path("settings/groups")},function(a){e.error("Deleting group failed: "+a)})})},a.save=function(){a.store.update("groups",a.group).then(function(){b.path("settings/groups")},function(a){e.error("Saving group failed: "+a)})}}]),angular.module("pimaticApp.settings").controller("GroupsController",["$scope","$location",function(a,b){a.edit=function(a){b.path("settings/groups/"+a)}}]),angular.module("pimaticApp").directive("attributeValue",function(){return{scope:{attribute:"=",useName:"="},template:'<div layout="row"><div flex layout="row" layout-align="start center" class="md-body-1">{{useName ? attribute.name : attribute.label}}</div><div><span>{{attribute.value}} {{attribute.unit}}</span></div></div>'}}),angular.module("pimaticApp").directive("deviceCard",function(){return{scope:{device:"="},template:"<ng-include src=\"'partials/devices/' + device.template + '.html'\"></ng-include>",controller:["$scope",function(a){a.getAttribute=function(b){var c=null;return angular.forEach(a.device.attributes,function(a){a.name==b&&(c=a)}),c},a.getConfig=function(b,c){return b in a.device.config?a.device.config:b in a.device.configDefaults?a.device.configDefaults[b]:c}}]}}),angular.module("pimaticApp").directive("pimaticTouchend",function(){return function(a,b,c){b.on("touchend",function(){a.$apply(function(){a.$eval(c.pimaticTouchend)})})}});