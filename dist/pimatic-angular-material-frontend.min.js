/*! 
 * Name:        pimatic-angular-material-frontend 
 * Description: Provides an AngularJS webinterface for pimatic with material design. 
 * Version:     0.1.0 
 * Homepage:    http://github.com/denniss17/pimatic-angular-material-frontend 
 * Date:        2015-09-20 
 */
angular.module("pimaticApp.configuration",[]),angular.module("pimaticApp.configuration").constant("pimaticHost",""),angular.module("pimaticApp.configuration").constant("apiProviderName","apiProvider"),angular.module("pimaticApp.devices",[]),angular.module("pimaticApp.settings",[]),angular.module("pimaticApp.data",["pimaticApp.configuration"]),angular.module("pimaticApp",["ngMaterial","ngRoute","ngMessages","pimaticApp.configuration","pimaticApp.devices","pimaticApp.settings","pimaticApp.data"]),angular.module("pimaticApp").config(["$routeProvider","$logProvider","debug",function(a,b,c){a.when("/home",{templateUrl:"partials/home.html",controller:"HomeController"}).when("/landing",{}).when("/about",{templateUrl:"partials/about.html"}).when("/login",{templateUrl:"partials/login.html",controller:"LoginController"}).when("/home/:pageId",{templateUrl:"partials/home.html",controller:"HomeController"}).when("/settings/groups",{templateUrl:"partials/settings/groups/index.html",controller:"GroupsController"}).when("/settings/groups/create",{templateUrl:"partials/settings/groups/create.html",controller:"GroupsCreateController"}).when("/settings/groups/:id",{templateUrl:"partials/settings/groups/edit.html",controller:"GroupsEditController"}).when("/settings/devices",{templateUrl:"partials/settings/devices/index.html",controller:"DevicesController"}).otherwise({redirectTo:"/landing"}),c="false"!=c,b.debugEnabled(c)}]),angular.module("pimaticApp").run(["$rootScope","$location","$injector","$log","store","auth",function(a,b,c,d,e,f){a.store=e,a.auth=f,a.version="0.1.0","@@"==a.version.substr(0,2)&&(a.version="dev"),a.state="starting",a.redirectedFrom=null,a.setState=function(c){a.state=c,("done"==c||"unauthenticated"==c)&&(angular.isUndefined(a.redirectedFrom)||null===a.redirectedFrom?(d.debug("New state:",c,"Redirecting to ","unauthenticated"==c?"/login":"/home"),b.path("unauthenticated"==c?"/login":"/home")):(b.path(a.redirectedFrom),d.debug("New state:",c,"Redirecting to ",a.redirectedFrom),a.redirectedFrom=null))},e.reload(),a.$on("$routeChangeStart",function(c,e){"starting"==a.state?"/landing"!=e.originalPath&&(d.debug("App","Application is loading, redirecting to the landing page"),a.redirectedFrom=e.originalPath,b.path("/landing")):f.isLoggedIn()||"/login"==e.originalPath||(d.debug("pimaticApp","Redirecting to login..."),a.redirectedFrom=e.originalPath,b.path("/login"))})}]),angular.module("pimaticApp").config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("blue").accentPalette("orange")}]),angular.module("pimaticApp.data").factory("apiProvider",["$http","$q","$rootScope","$log","baseProvider","pimaticHost","toast",function(a,b,c,d,e,f,g){var h={},i={groups:"group"};return angular.extend({},e,{socket:null,start:function(){h={},this.setupSocket()},apply:function(a){c.$$phase?a():c.$apply(a)},setupSocket:function(){var a=this.store,b=this;null!==this.socket&&this.socket.disconnect(),this.socket=io(f,{reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:3e3,timeout:2e4,forceNew:!0}),this.socket.on("connect",function(){d.debug("apiProvider","connect"),b.socket.emit("call",{id:"errorMessageCount",action:"queryMessagesCount",params:{criteria:{level:"error"}}}),b.socket.emit("call",{id:"guiSettings",action:"getGuiSetttings",params:{}}),b.socket.emit("call",{id:"updateProcessStatus",action:"getUpdateProcessStatus",params:{}})}),this.socket.on("error",function(a){d.debug("apiProvider","error",a),b.apply(function(){c.setState("unauthenticated")})}),this.socket.on("disconnect",function(){d.debug("apiProvider","disconnect")}),this.socket.on("hello",function(a){d.debug("apiProvider","hello",a),b.apply(function(){b.store.setUser(a),c.setState("done")})}),this.socket.on("callResult",function(a){switch(d.debug("apiProvider","callResult",a),a.id){case"errorMessageCount":break;case"guiSettings":break;case"updateProcessStatus":}}),this.socket.on("devices",function(a){d.debug("apiProvider","devices",a),b.handleIncomingData("devices",a)}),this.socket.on("rules",function(a){d.debug("apiProvider","rules",a),b.handleIncomingData("rules",a)}),this.socket.on("variables",function(a){d.debug("apiProvider","variables",a),b.handleIncomingData("variables",a)}),this.socket.on("pages",function(a){d.debug("apiProvider","pages",a),b.handleIncomingData("pages",a)}),this.socket.on("groups",function(a){d.debug("apiProvider","groups",a),b.handleIncomingData("groups",a)}),this.socket.on("deviceAttributeChanged",function(c){d.debug("apiProvider","deviceAttributeChanged",c),b.apply(function(){var b=a.get("devices",c.deviceId);null!==b&&angular.forEach(b.attributes,function(a){a.name==c.attributeName&&(a.value=c.value,a.lastUpdate=c.time)})})}),this.socket.on("variableValueChanged",function(c){d.debug("apiProvider","variableValueChanged",c),b.apply(function(){var b=a.get("variables",c.variableName);null!==b&&(b.value=c.variableValue)})}),this.socket.on("deviceChanged",function(c){d.debug("apiProvider","deviceChanged",c),b.apply(function(){a.update("devices",c,!0)})}),this.socket.on("deviceRemoved",function(c){d.debug("apiProvider","deviceRemoved",c),b.apply(function(){a.remove("devices",c,!0)})}),this.socket.on("deviceAdded",function(c){d.debug("apiProvider","deviceAdded",c),b.apply(function(){a.add("devices",c,!0)})}),this.socket.on("deviceOrderChanged",function(a){d.debug("apiProvider","deviceOrderChanged",a)}),this.socket.on("pageChanged",function(c){d.debug("apiProvider","pageChanged",c),b.apply(function(){a.update("pages",c,!0)})}),this.socket.on("pageRemoved",function(c){d.debug("apiProvider","pageRemoved",c),b.apply(function(){a.remove("pages",c,!0)})}),this.socket.on("pageAdded",function(c){d.debug("apiProvider","pageAdded",c),b.apply(function(){a.add("pages",c,!0)})}),this.socket.on("pageOrderChanged",function(a){d.debug("apiProvider","pageOrderChanged",a)}),this.socket.on("groupChanged",function(c){d.debug("apiProvider","groupChanged",c),b.apply(function(){a.update("groups",c,!0)})}),this.socket.on("groupRemoved",function(c){d.debug("apiProvider","groupRemoved",c),b.apply(function(){a.remove("groups",c,!0)})}),this.socket.on("groupAdded",function(c){d.debug("apiProvider","groupAdded",c),b.apply(function(){a.add("groups",c,!0)})}),this.socket.on("groupOrderChanged",function(a){d.debug("apiProvider","groupOrderChanged",a)}),this.socket.on("ruleChanged",function(c){d.debug("apiProvider","ruleChanged",c),b.apply(function(){a.update("rules",c,!0)})}),this.socket.on("ruleAdded",function(c){d.debug("apiProvider","ruleAdded",c),b.apply(function(){a.add("rules",c,!0)})}),this.socket.on("ruleRemoved",function(c){d.debug("apiProvider","ruleRemoved",c),b.apply(function(){a.remove("rules",c,!0)})}),this.socket.on("ruleOrderChanged",function(a){d.debug("apiProvider","ruleOrderChanged",a)}),this.socket.on("variableChanged",function(c){d.debug("apiProvider","variableChanged",c),b.apply(function(){a.update("variables",c,!0)})}),this.socket.on("variableAdded",function(c){d.debug("apiProvider","variableAdded",c),b.apply(function(){a.add("variables",c,!0)})}),this.socket.on("variableRemoved",function(c){d.debug("apiProvider","variableRemoved",c),b.apply(function(){a.remove("variables",c,!0)})}),this.socket.on("variableOrderChanged",function(a){d.debug("apiProvider","variableOrderChanged",a)}),this.socket.on("updateProcessStatus",function(a){d.debug("apiProvider","updateProcessStatus",a)}),this.socket.on("updateProcessMessage",function(a){d.debug("apiProvider","updateProcessMessage",a)}),this.socket.on("messageLogged",function(a){d.debug("apiProvider","messageLogged",a),"debug"!=a.level&&g.show(a.msg),"error"==a.level})},login:function(c,d,e){return b(function(b,g){var h={username:c,password:d};e&&(h.rememberMe=!0),a.post(f+"/login",h).success(function(a){a.success?b({username:a.username,rememberMe:a.rememberMe,role:a.role}):g(a.message)}).error(function(a){g(a.message)})})},logout:function(){return b(function(b){a.get(f+"/logout").success(function(){b()}).error(function(){b()})})},handleIncomingData:function(a,b){a in h&&"promises"in h[a]?(angular.forEach(h[a].promises,function(a){a.resolve(b)}),delete h[a]):(h[a]={},h[a].data=b)},deviceAction:function(c,d){return b(function(b,e){a.get(f+"/api/device/"+c+"/"+d).success(function(a){a.success?b():e()}).error(function(){e()})})},add:function(c,d){return b(function(b,e){var g=i[c],h={};h[g]=d,a.post(f+"/api/"+c+"/"+d.id,h).then(function(a){b(a[g])},function(a){e(a.message)})})},update:function(c,d){return b(function(b,e){var g=i[c],h={};h[g]=d,a.patch(f+"/api/"+c+"/"+d.id,h).then(function(a){b(a[g])},function(a){e(a.message)})})},remove:function(c,d){return b(function(b,e){a["delete"](f+"/api/"+c+"/"+d.id).then(function(a){b(a.removed)},function(a){e(a.message)})})},load:function(a){if(a in h&&"data"in h[a]){var c=b(function(b){b(h[a].data)});return delete h[a],c}var d=b.defer();return angular.isUndefined(h[a])&&(h[a]={}),angular.isUndefined(h[a].promises)&&(h[a].promises=[]),h[a].promises.push(d),d.promise}})}]),angular.module("pimaticApp.data").factory("baseProvider",["$q",function(a){return{store:null,setStore:function(a){this.store=a},deviceAction:function(){return a(function(a,b){b()})},login:function(){return a(function(a,b){b("Not implemented")})},logout:function(){return a(function(a,b){b("Not implemented")})},start:function(){},load:function(){return a(function(a,b){b("Not implemented")})},add:function(){return a(function(a,b){b("Not implemented")})},update:function(){return a(function(a,b){b("Not implemented")})},remove:function(){return a(function(a,b){b("Not implemented")})}}}]),angular.module("pimaticApp.data").factory("fixtureProvider",["$http","$q","baseProvider",function(a,b,c){var d={};return angular.extend({},c,{start:function(){d={},a.get("assets/fixtures/devices.json").then(function(a){d.devices=a.data},function(){d.devices=[]}),a.get("assets/fixtures/groups.json").then(function(a){d.groups=a.data},function(){d.groups=[]}),a.get("assets/fixtures/pages.json").then(function(a){d.pages=a.data},function(){d.pages=[]}),a.get("assets/fixtures/rules.json").then(function(a){d.rules=a.data},function(){d.rules=[]}),a.get("assets/fixtures/variables.json").then(function(a){d.variables=a.data},function(){d.variables=[]})},load:function(a){return b(function(b){for(;!(a in d););b(d[a])})}})}]),angular.module("pimaticApp").factory("auth",["store","$injector","$location","$q",function(a,b,c,d){var e={store:a,isLoggedIn:function(){return null!==a.getUser()},login:function(b,c,e){var f=this;return d(function(d,g){f.store.provider.login(b,c,e).then(function(b){a.reload(),a.setUser(b),d(b)},g)})},logout:function(){var b=this;return d(function(c,d){b.store.provider.logout().then(function(){a.setUser(null),a.reset(),c()},d)})}};return e}]),angular.module("pimaticApp.data").factory("store",["$q","$injector","$log","apiProviderName",function(a,b,c,d){var e={provider:b.get(d),store:{},reset:function(){c.debug("=== STORE RESET ==="),this.store={user:{timestamp:0,loading:!1,data:null},devices:{timestamp:0,loading:!1,data:[]},groups:{timestamp:0,loading:!1,data:[]},pages:{timestamp:0,loading:!1,data:[]},rules:{timestamp:0,loading:!1,data:[]},variables:{timestamp:0,loading:!1,data:[]}},this.provider.setStore(this)},reload:function(){this.reset(),this.provider.start()},isLoading:function(a){return this.store[a].loading},getUser:function(){return this.store.user.data},setUser:function(a){this.store.user.data=a},get:function(a,b,c){var d=this;if(a in d.store){if(0!==d.store[a].timestamp||d.store[a].loading||(d.store[a].loading=!0,c||d.provider.load(a).then(function(b){d.store[a].data=b;var c=new Date;d.store[a].timestamp=c.getTime(),d.store[a].loading=!1},function(){d.store[a].loading=!1})),angular.isUndefined(b))return d.store[a].data;var e=null;return angular.forEach(d.store[a].data,function(a){a.id==b&&(e=a)}),e}return angular.isUndefined(b)?[]:null},add:function(b,d,e){var f=this.provider,g=this;c.debug("store","add()","type=",b,"object=",d,"skipApi=",e);var h=function(){var c=g.get(b,d.id,e);return null===c?a(function(a){g.get(b,void 0,e).push(d),a(d)}):g.update(b,d,e)};return a(function(a,c){e?h(d).then(function(b){a(b)}):f.add(b,d).then(function(b){h(b).then(function(b){a(b)})},function(a){c(a)})})},update:function(b,d,e){var f=this.provider,g=this;return c.debug("store","update()","type=",b,"object=",d,"skipApi=",e),a(function(a,c){var h=g.get(b,d.id);return null===h?void c("Fatal: update called, but object does not exist"):void(e?(angular.merge(h,d),a(h)):f.update(b,d).then(function(b){angular.merge(h,b),a(h)},function(a){c(a)}))})},remove:function(b,d,e){var f=this;if(c.debug("store","remove()","type=",b,"object=",d,"skipApi=",e),!(b in f.store))return a(function(a,b){b("Type is not valid")});var g=function(){var a=-1;angular.forEach(f.store[b].data,function(b,c){a=b.id==d.id?c:a}),a>=0&&f.store[b].data.splice(a,1)};return a(function(a,c){e?(g(d),a(d)):f.provider.remove(b,d).then(function(b){g(d),a(b)},function(a){c(a)})})}};return e}]),angular.module("pimaticApp").factory("toast",["$mdToast",function(a){return{show:function(b){a.show(a.simple().content(b))},error:function(b){a.show(a.simple().content(b))},deviceActionDone:function(a,b){this.show("Done: "+b+" "+a.id)},deviceActionFail:function(a,b){this.error("Fail: "+b+" "+a.id)}}}]),angular.module("pimaticApp.devices").controller("SwitchController",["$scope","store","toast",function(a,b,c){a.updateValue=function(d){var e=d.value?"turnOn":"turnOff";b.provider.deviceAction(a.device.id,e).then(function(){c.deviceActionDone(a.device,e)},function(){d.value=!d.value,c.deviceActionFail(a.device,e)})}}]),angular.module("pimaticApp.devices").controller("ThermostatController",[function(){}]),angular.module("pimaticApp").controller("HomeController",["$scope",function(a){a.selectedTab=0}]),angular.module("pimaticApp").controller("LoginController",["$scope","auth",function(a,b){null!==b.user&&a.setState("done"),a.form={},a.login=function(){a.form.message=null,a.form.busy=!0,b.login(a.form.username,a.form.password,a.form.rememberMe).then(function(){a.form.busy=!1,a.setState("done")},function(b){a.form.message=b,a.form.busy=!1})}}]),angular.module("pimaticApp").controller("MainController",["$scope","$mdSidenav","$mdMedia","auth",function(a,b,c,d){a.$mdMedia=c,a.toggleMenu=function(){b("left").toggle()},a.logout=function(){a.toggleMenu(),d.logout().then(function(){a.setState("unauthenticated")})}}]),angular.module("pimaticApp.settings").controller("DevicesController",["$scope",function(a){a.ungroupedDevices=function(){var b=a.store.get("groups"),c=a.store.get("devices"),d=[];return angular.forEach(c,function(a){d.push(a.id)}),angular.forEach(b,function(a){angular.forEach(a.devices,function(a){var b=d.indexOf(a);b>=0&&d.splice(b,1)})}),d}}]),angular.module("pimaticApp.settings").controller("GroupsCreateController",["$scope","$location","toast",function(a,b,c){a.group={},a.cancel=function(a){a.preventDefault(),b.path("settings/groups")},a.save=function(){a.store.add("groups",a.group).then(function(){b.path("settings/groups")},function(a){c.error("Saving group failed: "+a)})}}]),angular.module("pimaticApp.settings").controller("GroupsEditController",["$scope","$location","$routeParams","$mdDialog","toast",function(a,b,c,d,e){a.group=angular.copy(a.store.get("groups",c.id)),null===a.group&&b.path("settings/groups"),a.cancel=function(a){a.preventDefault(),b.path("settings/groups")},a["delete"]=function(c){c.preventDefault();var f=d.confirm().title("Are you sure you want to delete this group?").content(a.group.id).ariaLabel("Delete group").ok("Yes").cancel("No").targetEvent(c);d.show(f).then(function(){a.store.remove("groups",a.group).then(function(){b.path("settings/groups")},function(a){e.error("Deleting group failed: "+a)})})},a.save=function(){a.store.update("groups",a.group).then(function(){b.path("settings/groups")},function(a){e.error("Saving group failed: "+a)})}}]),angular.module("pimaticApp.settings").controller("GroupsController",["$scope","$location",function(a,b){a.edit=function(a){b.path("settings/groups/"+a)}}]),angular.module("pimaticApp").directive("deviceCard",function(){return{scope:{device:"="},template:"<ng-include src=\"'partials/devices/' + device.template + '.html'\"></ng-include>",controller:["$scope",function(a){a.getAttribute=function(b){var c=null;return angular.forEach(a.device.attributes,function(a){a.name==b&&(c=a)}),c}}]}});